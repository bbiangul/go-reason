# GoReason v4 Evaluation Report

## Changes from v3

### New Eval Infrastructure

1. **Ground truth explanations**: Added `Explanation` field to every test case (140 total) with page citations from the PDF. Stored in eval output JSON alongside model answer for offline review.

2. **New hallucination detection metrics** (`eval/metrics.go`):
   - `computeClaimGrounding()`: Checks what fraction of significant terms/numbers in the answer appear in retrieved sources. Score 0-1.
   - `computeHallucinationScore()`: Detects fabricated numbers (penalty 1.0) and ungrounded technical terms (penalty 0.5). Returns 1.0 (clean) to 0.0 (heavy hallucination).
   - Both metrics are **informational signals** (tracked in report but not used as pass gates). The hallucination score had too many false positives on correct answers containing technical terms.

3. **Pass criteria**: Unchanged from v3: `Accuracy >= 0.5 && Faithfulness >= 0.5`. The hallucination threshold was tested at 0.3 but reverted due to false-fails on tests with perfect accuracy (e.g., THD level answer with 3 citations failed because technical Spanish terms in the answer text weren't found in specific source chunks).

### Dataset Changes

**Fixes to existing super-hard tests** (4 tests modified):
- Q2: Removed PET-specific facts (document has zero PET-specific parameters)
- Q19: Replaced meta-question about document parsing with grounded changeover question
- Q25: Replaced `"opacidad|opacity"` with `"presencia|presence"` (matching section 7.3.2)
- Q30: Rephrased to ask about specific normative standards in the document

**20 new super-hard tests** (total: 50 super-hard):
- 5 graph-multi-hop: Connecting info from 2+ distant document sections
- 5 anti-hallucination: Questions about info NOT in the document — model must refuse
- 5 numerical precision: Exact numbers from specific pages
- 5 reasoning chains: Logical inference from document facts

**Anti-hallucination test design**: Uses 2-fact pattern: broad negation (`"not|no|cannot|sin"`) + topic confirmation (`"camera|BPM|Ethernet"`). This is robust to model phrasing variations, unlike brittle phrase-matching (`"not specified|not mentioned|..."`).

## Configuration

| Parameter | Value |
|-----------|-------|
| Chat provider | groq |
| Chat model | openai/gpt-oss-120b |
| Embed provider | openai |
| Embed model | text-embedding-3-small |
| Embed dim | 1536 |
| Max results | 25 |
| Max rounds | 3 |
| RRF weights | vec=1.0, fts=1.0, graph=0.5 |
| Temperature | 0 |

## v4 Results Summary

| Difficulty | Pass Rate | Tests | v3 Baseline | Status |
|-----------|-----------|-------|-------------|--------|
| Easy | **100%** (30/30) | Factual extraction | 100% (30/30) | No regression |
| Medium | **96.7%** (29/30) | Cross-reference | 100% (30/30) | 1 flaky (non-determinism) |
| Hard | **100%** (30/30) | Multi-hop reasoning | 100% (30/30) | No regression |
| Super-Hard | **96.0%** (48/50) | Synthesis + new categories | 96.7% (29/30) | 2 consistent fails in 50 tests |
| **Total** | **137/140 (97.9%)** | All difficulties | 119/120 (99.2%) | |

Note: v3 had 120 total tests (30 per difficulty). v4 has 140 tests (50 super-hard). The raw count of failures is 3 vs 1, but the test set is 17% larger and includes deliberately harder categories.

## Easy Results (30/30 = 100%)

All 30 tests pass with Accuracy=1.00, Faithfulness=1.00.

| # | Question | Category | Acc | Hall | Grnd | Conf |
|---|----------|----------|-----|------|------|------|
| 1 | Operating temperature range | specs | 1.00 | 0.41 | 0.34 | 0.85 |
| 2 | Tracker board part number | components | 1.00 | 0.68 | 0.58 | 0.85 |
| 3 | Equipment operating voltage | specs | 1.00 | 0.56 | 0.25 | 0.85 |
| 4 | Noise emission level | specs | 1.00 | 0.45 | 0.31 | 0.85 |
| 5 | Air pressure requirement | specs | 1.00 | 0.43 | 0.24 | 1.00 |
| 6 | Inspection bridge material | specs | 1.00 | 0.56 | 0.42 | 0.85 |
| 7 | Weight of Model A Standard | specs | 1.00 | 0.33 | 0.23 | 0.85 |
| 8 | IP protection rating | specs | 1.00 | 0.30 | 0.20 | 0.85 |
| 9 | THD level required | specs | 1.00 | 0.29 | 0.31 | 1.00 |
| 10 | Tracker board IP address | components | 1.00 | 0.39 | 0.28 | 0.85 |
| 11 | Subnet mask of the Tracker | components | 1.00 | 0.41 | 0.34 | 0.85 |
| 12 | Fuse rating for Tracker outputs | components | 1.00 | 0.68 | 0.43 | 0.85 |
| 13 | CPU CUBE processor | components | 1.00 | 0.45 | 0.39 | 0.85 |
| 14 | Preinstalled operating system | components | 1.00 | 0.38 | 0.43 | 0.85 |
| 15 | Encoder part number | components | 1.00 | 0.38 | 0.33 | 0.85 |
| 16 | Trigger sensor part number | components | 1.00 | 0.39 | 0.29 | 0.85 |
| 17 | Standard cap diameter | specs | 1.00 | 0.47 | 0.36 | 0.85 |
| 18 | Tracker board inputs | components | 1.00 | 0.75 | 0.50 | 0.85 |
| 19 | Tracker board outputs | components | 1.00 | 0.68 | 0.52 | 0.85 |
| 20 | Tracker power supply voltage | components | 1.00 | 0.53 | 0.43 | 0.85 |
| 21 | Power consumption without AC | specs | 1.00 | 0.43 | 0.28 | 0.85 |
| 22 | Power consumption with AC | specs | 1.00 | 0.51 | 0.41 | 0.85 |
| 23 | Cut protection level for gloves | safety | 1.00 | 0.42 | 0.42 | 0.85 |
| 24 | Wire gauge for cabling | specs | 1.00 | 0.38 | 0.16 | 0.85 |
| 25 | Cabinet paint color | specs | 1.00 | 0.50 | 0.39 | 0.85 |
| 26 | Protection window glass type | specs | 1.00 | 0.46 | 0.27 | 0.85 |
| 27 | Weight of Model B cabinet | specs | 1.00 | 0.22 | 0.17 | 0.85 |
| 28 | Weight of Model C Standard XL | specs | 1.00 | 0.35 | 0.20 | 0.85 |
| 29 | Document revision date | specs | 1.00 | 0.48 | 0.30 | 0.85 |
| 30 | Encoder pulses per revolution | components | 1.00 | 0.52 | 0.38 | 0.85 |

### Easy Aggregate Metrics

| Metric | Value |
|--------|-------|
| Accuracy | 1.00 |
| Faithfulness | 1.00 |
| Claim Grounding | 0.34 |
| Hallucination Score | 0.46 |
| Confidence | 0.86 |
| Citation Quality | 0.64 |
| Tokens | 117,206 |
| Run Time | ~70s |

## Medium Results (29/30 = 96.7%)

| # | Question | Acc | Diag | Status |
|---|----------|-----|------|--------|
| 1 | Inspection types supported by AV-FM/AV-FF | 1.00 | PASS | PASS |
| 2 | Components tracked by Tracker board | 0.67 | RETRIEVAL_MISS | PASS |
| 3 | Differences between AV-FM and AV-FF | 1.00 | PASS | PASS |
| 4 | Sequence of steps in inspection process | 0.25 | RETRIEVAL_MISS | **FLAKY** |
| 5 | User roles in the system | 1.00 | PASS | PASS |
| 6 | Three SKU states | 1.00 | PASS | PASS |
| 7 | Screens in main menu | 0.67 | RETRIEVAL_MISS | PASS |
| 8 | Signal beacon light colors | 1.00 | PASS | PASS |
| 9 | Safety standards compliance | 1.00 | PASS | PASS |
| 10 | Types of cooling systems | 1.00 | PASS | PASS |
| 11 | Electrical current at 120V | 1.00 | PASS | PASS |
| 12 | GUI header information | 1.00 | PASS | PASS |
| 13 | Cap tracking tool parameters | 1.00 | PASS | PASS |
| 14 | Data recorded by inspection system | 1.00 | PASS | PASS |
| 15 | Equipment models in manual | 1.00 | PASS | PASS |
| 16 | Power failure handling | 1.00 | PASS | PASS |
| 17 | Communication protocols | 1.00 | PASS | PASS |
| 18 | Environmental conditions | 1.00 | PASS | PASS |
| 19 | Personal protective equipment | 1.00 | PASS | PASS |
| 20 | Global Learning function | 1.00 | PASS | PASS |
| 21 | Container parameters | 1.00 | PASS | PASS |
| 22 | Inactivity timeout | 1.00 | PASS | PASS |
| 23 | Grounding specification | 0.67 | RETRIEVAL_MISS | PASS |
| 24 | IMAGO outputs | 1.00 | PASS | PASS |
| 25 | Encoder function | 1.00 | PASS | PASS |
| 26 | Simultaneous inspections | 1.00 | PASS | PASS |
| 27 | Multicam cap opacity options | 1.00 | PASS | PASS |
| 28 | Laser sensor in Profiler | 0.50 | MODEL_MISS | PASS |
| 29 | Bottle rejection in fill level | 1.00 | PASS | PASS |
| 30 | Steps to copy a SKU | 1.00 | PASS | PASS |

Note: Medium shows 1 flaky test per run due to model non-determinism (gpt-oss-120b at temp=0 on Groq still varies). Different test fails each run: test 4 in run 1, test 1 in run 2. All 30 tests pass across multiple runs collectively.

## Hard Results (30/30 = 100%)

All 30 hard tests pass. Several show RETRIEVAL_MISS diagnosis (partial fact coverage) but still meet accuracy threshold.

## Super-Hard Results (48/50 = 96.0%)

### New Category Breakdown

| Category | Tests | Passed | Rate |
|----------|-------|--------|------|
| synthesis (original 30) | 30 | 28 | 93.3% |
| graph-multi-hop (new) | 5 | 5 | **100%** |
| anti-hallucination (new) | 5 | 5 | **100%** |
| numerical (new) | 5 | 5 | **100%** |
| reasoning (new) | 5 | 5 | **100%** |

All 20 new tests pass. Both failures are in the original synthesis category.

### Per-Test Results

| # | Question | Category | Acc | Diag | Status |
|---|----------|----------|-----|------|--------|
| 1 | Troubleshooting incorrect rejections | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| 2 | SKU container type switching | synthesis | 1.00 | PASS | PASS |
| 3 | Five inspection tools quality control | synthesis | 1.00 | PASS | PASS |
| 4 | Infrastructure requirements | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| 5 | Partially filled beer bottle with foam | synthesis | 1.00 | PASS | PASS |
| 6 | Safety architecture analysis | synthesis | 1.00 | PASS | PASS |
| 7 | Failure modes and alarm responses | synthesis | 1.00 | PASS | PASS |
| 8 | 12-hour production shift accuracy | synthesis | 1.00 | PASS | PASS |
| 9 | Vortex vs Rittal AC comparison | synthesis | 1.00 | PASS | PASS |
| 10 | Small medicine bottle optimization | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| 11 | MDIR 2006/42/EC influence | synthesis | 1.00 | PASS | PASS |
| 12 | Data architecture | synthesis | 1.00 | PASS | PASS |
| 13 | Maintenance risks and mitigations | synthesis | 1.00 | PASS | PASS |
| 14 | Post-installation calibration validation | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| 15 | Normative standards synthesis | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| 16 | Image resolution, lens, accuracy | synthesis | 1.00 | PASS | PASS |
| 17 | Concurrent multi-camera inspections | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| 18 | User management lifecycle | synthesis | 1.00 | PASS | PASS |
| 19 | Container params during changeover | synthesis | 1.00 | PASS | PASS |
| 20 | Rejection timing at different speeds | synthesis | 1.00 | PASS | PASS |
| 21 | 10% humidity increase impact | synthesis | 1.00 | PASS | PASS |
| 22 | SKU strategy for 50 bottle sizes | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| 23 | Electrical defense-in-depth | synthesis | 1.00 | PASS | PASS |
| 24 | Glossary inspection parameters | synthesis | 0.50 | RETRIEVAL_MISS | PASS |
| **25** | **Bottles without caps** | **synthesis** | **0.33** | **RETRIEVAL_MISS** | **FAIL** |
| 26 | Operator training requirements | synthesis | 1.00 | PASS | PASS |
| 27 | Image acquisition pipeline | synthesis | 1.00 | PASS | PASS |
| 28 | Future upgrades and expansions | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| 29 | Fill level measurement parameters | synthesis | 0.67 | RETRIEVAL_MISS | PASS |
| **30** | **Normative standards and safety** | **synthesis** | **0.33** | **RETRIEVAL_MISS** | **FAIL** |
| 31 | Foam compensation + window params | graph-multi-hop | 1.00 | PASS | PASS |
| 32 | Signal path trigger → rejection | graph-multi-hop | 1.00 | PASS | PASS |
| 33 | Alarm severity levels vs components | graph-multi-hop | 1.00 | PASS | PASS |
| 34 | Global Learning + pixel/mm + diameter | graph-multi-hop | 1.00 | PASS | PASS |
| 35 | Compensador 1 & 2 + encoder + low speed | graph-multi-hop | 1.00 | PASS | PASS |
| 36 | Max production speed (anti-halluc.) | anti-hallucination | 1.00 | CHUNK_MISS | PASS |
| 37 | Camera megapixels (anti-halluc.) | anti-hallucination | 1.00 | CHUNK_MISS | PASS |
| 38 | WiFi support (anti-halluc.) | anti-hallucination | 1.00 | PASS | PASS |
| 39 | ML/AI algorithms (anti-halluc.) | anti-hallucination | 1.00 | PASS | PASS |
| 40 | Cloud connectivity (anti-halluc.) | anti-hallucination | 1.00 | PASS | PASS |
| 41 | Current ratings 120V/240V | numerical | 1.00 | PASS | PASS |
| 42 | Weights Model A/B/C | numerical | 1.00 | PASS | PASS |
| 43 | Air pressure + edge size values | numerical | 0.80 | RETRIEVAL_MISS | PASS |
| 44 | Ground voltage + wire gauge + cap | numerical | 1.00 | PASS | PASS |
| 45 | Timeout + pulse width + debounce | numerical | 0.67 | CHUNK_MISS | PASS |
| 46 | Encoder pulse divider calculation | reasoning | 1.00 | PASS | PASS |
| 47 | Foam compensation calculation | reasoning | 1.00 | PASS | PASS |
| 48 | SKU copy restriction | reasoning | 1.00 | PASS | PASS |
| 49 | Noise range 70-80 dB(A) | reasoning | 1.00 | PASS | PASS |
| 50 | Foam + Borde Inferior for beer | reasoning | 1.00 | PASS | PASS |

### Failure Analysis

**Test 25: "How does the system handle edge cases like bottles without caps?"** (CONSISTENT FAIL)
- **Root cause**: MODEL_MISS. Sources include section 7.3.2 "Presencia/Defecto de Tapa" but model focuses narrowly on cap-height tracking and never mentions the presence/defect check.
- **Expected**: tapa|cap, defecto|defect|non-conform, presencia|presence
- **Found**: Only "cap" (1/3). Model gives correct-but-incomplete answer about cap tracking.
- **Fix options**: Better model, multi-round validation, prompt engineering. All carry regression risk.
- **Status**: Deferred — known limitation of gpt-oss-120b synthesis capability.

**Test 30: "What specific normative standards does the document reference?"** (RETRIEVAL_MISS)
- **Root cause**: RETRIEVAL_MISS. Pages 22-24 with ISO 12100 and IP54 pushed out of top-25 by other standard-related chunks.
- **Expected**: ISO 12100, IP54, grupo de riesgo|risk group
- **Found**: Only 1/3. Model mentions MDIR 2006/42/EC and EN 60204 (in retrieved chunks) but can't mention ISO 12100/IP54 (not retrieved).
- **Fix options**: Increase max_results (risk: dilutes context quality), add targeted entity links for standards in graph.
- **Status**: Deferred — low priority at 96% pass rate.

## Model Non-Determinism

gpt-oss-120b on Groq at temperature=0 still shows run-to-run variance. Medium level shows 1 different test failing each run:

| Run | Failed Test | Diagnosis |
|-----|-------------|-----------|
| Medium run 1 | Test 4 (inspection steps) | RETRIEVAL_MISS |
| Medium run 2 | Test 1 (inspection types) | RETRIEVAL_MISS |

All 30 medium tests pass across multiple runs collectively. This is acceptable variance for a retrieval-dependent system.

## New Metrics Analysis

### Hallucination Score Distribution

The new hallucination detection metrics show interesting patterns:

| Difficulty | Avg Hall | Avg Grnd | Observation |
|-----------|----------|----------|-------------|
| Easy | 0.46 | 0.34 | Answers contain technical terms not in specific chunks |
| Medium | 0.29 | 0.27 | Longer answers = more ungrounded terms |
| Hard | 0.25 | 0.24 | Multi-hop answers reference many concepts |
| Super-Hard | 0.28 | 0.25 | Synthesis answers have broader vocabulary |

The hallucination score is consistently low (0.25-0.46) across ALL difficulties, even on tests with perfect accuracy. This confirms the metric detects "source vocabulary coverage" rather than actual hallucination. It's useful as a relative signal (lower = more novel vocabulary) but not as an absolute pass/fail gate.

**Anti-hallucination tests**: These correctly show low Hall scores (0.08-0.40) when the model refuses to answer — the refusal text contains words not in sources. This is expected and correct behavior.

### Claim Grounding Observations

Claim grounding scores are low (0.10-0.60) because:
1. Model answers in English while sources are in Spanish → term mismatch
2. Model paraphrases rather than quoting verbatim → vocabulary divergence
3. Retrieved top-25 chunks don't contain ALL relevant document content → partial coverage

These are structural properties of cross-language RAG, not bugs.

## Files Modified in v4

| File | Changes |
|------|---------|
| `eval/dataset.go` | Added `Explanation` field to `TestCase` struct |
| `eval/metrics.go` | Added `computeClaimGrounding()`, `computeHallucinationScore()`, `numberPattern`, dedup |
| `eval/evaluator.go` | Added new metrics to `TestResult`/`AggregateMetrics`, `FormatReport()` |
| `eval/altavision_dataset.go` | Fixed Q2/Q19/Q25/Q30, added 20 new super-hard tests, added 140 explanations |
| `eval/altavision_eval_test.go` | Updated super-hard expected count 30→50 |
| `eval/eval_test.go` | Added tests for `computeClaimGrounding`, `computeHallucinationScore`, updated `TestFormatReport` |
| `.gitignore` | Added `/goreason-eval`, `\?_journal_mode=*` |

## Run Artifacts

| Difficulty | Run Dir | Report |
|-----------|---------|--------|
| Easy | `evals/runs/2026-02-04_09-25-18/` | 30/30 |
| Medium | `evals/runs/2026-02-04_09-46-43/` | 29/30 |
| Hard | `evals/runs/2026-02-04_09-28-52/` | 30/30 |
| Super-Hard | `evals/runs/2026-02-04_09-42-30/` | 48/50 |
