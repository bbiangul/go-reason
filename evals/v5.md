# GoReason v5 Evaluation Report

## Changes from v4

### Adaptive Retrieval for Synthesis Queries

Synthesis questions that ask for exhaustive information ("What are ALL the standards?", "List every parameter") scatter facts across 5+ topically distant chunks. The top-25 retrieval window covered concentrated sections but missed isolated mentions elsewhere in the document.

**Evidence from v4**: Test 30 (normative standards) failed because IP54 (page 29, electrical specs) and grupo de riesgo (page 21, residual risks) were semantically distant from "normative standards" and never retrieved.

#### Changes

1. **Synthesis query detection** (`retrieval/helpers.go`):
   - `isSynthesisQuery()` detects exhaustive-intent patterns ("all the", "every", "comprehensive", "list all", etc.)
   - Also triggers on long queries (15+ words) with multiple question keywords
   - Language-agnostic: only English patterns (queries are expected in English; cross-language translator handles document matching)

2. **Adaptive max_results** (`retrieval/retrieval.go`):
   - When synthesis mode detected, widens retrieval window from 25 to 40 results
   - Each retrieval method (vec, FTS, graph) returns 40 candidates instead of 25
   - RRF fusion pool grows from ~75 to ~120 candidates

3. **1-hop graph expansion** (`retrieval/retrieval.go`, `store/store.go`):
   - In synthesis mode, after initial entity matching (exact + fuzzy + name_en), performs 1-hop relationship traversal
   - New `GetRelatedEntities()` method: single SQL query joins entities via relationships table
   - Discovers entities connected to seed entities (e.g., "seguridad y normativa" → "ip54")
   - Only triggers in synthesis mode; normal queries unaffected

4. **Follow-up retrieval** (`goreason.go`):
   - After round-1 reasoning, extracts identifiers (standards, part numbers, model numbers) from the LLM answer
   - Checks which identifiers appear in retrieved chunk content
   - Terms found in answer but NOT in any chunk trigger a targeted FTS follow-up search
   - Merges new chunks, re-runs reasoning with expanded context
   - Gate: only triggers when synthesis mode AND initial retrieval filled the entire window
   - False positive filtering: ignores "Figure A123", "Table B456", etc.
   - Replaces hyphens with spaces before FTS query to avoid tokenization corruption

### Default Model Changes (`cmd/eval/main.go`)

- Chat: `groq` / `openai/gpt-oss-120b` (was `openrouter` / `qwen/qwen3-30b-a3b`)
- Embedding: `openai` / `text-embedding-3-small` / dim 1536 (was `ollama` / `nomic-embed-text` / dim 768)

## Configuration

| Parameter | Value |
|-----------|-------|
| Chat provider | groq |
| Chat model | openai/gpt-oss-120b |
| Embed provider | openai |
| Embed model | text-embedding-3-small |
| Embed dim | 1536 |
| Max results | 25 (adaptive: 40 for synthesis) |
| Max rounds | 3 |
| RRF weights | vec=1.0, fts=1.0, graph=0.5 |
| Temperature | 0 |

## v5 Results Summary

| Difficulty | Pass Rate | Tests | v4 Baseline | Status |
|-----------|-----------|-------|-------------|--------|
| Easy | **100%** (30/30) | Factual extraction | 100% (30/30) | No regression |
| Medium | **100%** (30/30) | Cross-reference | 96.7% (29/30) | Flaky test passed this run |
| Hard | **100%** (30/30) | Multi-hop reasoning | 100% (30/30) | No regression |
| Super-Hard | **98.0%** (49/50) | Synthesis + new categories | 96.0% (48/50) | Test 30 fixed, test 25 remains |
| **Total** | **139/140 (99.3%)** | All difficulties | 137/140 (97.9%) | +2 net improvement |

## Easy Results (30/30 = 100%)

All 30 tests pass with Accuracy=1.00, Faithfulness=1.00.

| # | Question | Category | Acc | Hall | Grnd | Conf |
|---|----------|----------|-----|------|------|------|
| 1 | Operating temperature range | specs | 1.00 | 0.38 | 0.33 | 0.85 |
| 2 | Tracker board part number | components | 1.00 | 0.68 | 0.58 | 0.85 |
| 3 | Equipment operating voltage | specs | 1.00 | 0.56 | 0.25 | 0.85 |
| 4 | Noise emission level | specs | 1.00 | 0.45 | 0.31 | 0.85 |
| 5 | Air pressure requirement | specs | 1.00 | 0.43 | 0.24 | 1.00 |
| 6 | Inspection bridge material | specs | 1.00 | 0.56 | 0.42 | 0.85 |
| 7 | Weight of Model A Standard | specs | 1.00 | 0.33 | 0.23 | 0.85 |
| 8 | IP protection rating | specs | 1.00 | 0.30 | 0.20 | 0.85 |
| 9 | THD level required | specs | 1.00 | 0.29 | 0.31 | 1.00 |
| 10 | Tracker board IP address | components | 1.00 | 0.39 | 0.28 | 0.85 |
| 11 | Subnet mask of the Tracker | components | 1.00 | 0.41 | 0.34 | 0.85 |
| 12 | Fuse rating for Tracker outputs | components | 1.00 | 0.68 | 0.43 | 0.85 |
| 13 | CPU CUBE processor | components | 1.00 | 0.45 | 0.39 | 0.85 |
| 14 | Preinstalled operating system | components | 1.00 | 0.38 | 0.43 | 0.85 |
| 15 | Encoder part number | components | 1.00 | 0.38 | 0.33 | 0.85 |
| 16 | Trigger sensor part number | components | 1.00 | 0.39 | 0.29 | 0.85 |
| 17 | Standard cap diameter | specs | 1.00 | 0.47 | 0.36 | 0.85 |
| 18 | Tracker board inputs | components | 1.00 | 0.75 | 0.50 | 0.85 |
| 19 | Tracker board outputs | components | 1.00 | 0.68 | 0.52 | 0.85 |
| 20 | Tracker power supply voltage | components | 1.00 | 0.53 | 0.43 | 0.85 |
| 21 | Power consumption without AC | specs | 1.00 | 0.43 | 0.28 | 0.85 |
| 22 | Power consumption with AC | specs | 1.00 | 0.51 | 0.41 | 0.85 |
| 23 | Cut protection level for gloves | safety | 1.00 | 0.42 | 0.42 | 0.85 |
| 24 | Wire gauge for cabling | specs | 1.00 | 0.38 | 0.16 | 0.85 |
| 25 | Cabinet paint color | specs | 1.00 | 0.50 | 0.39 | 0.85 |
| 26 | Protection window glass type | specs | 1.00 | 0.46 | 0.27 | 0.85 |
| 27 | Weight of Model B cabinet | specs | 1.00 | 0.22 | 0.17 | 0.85 |
| 28 | Weight of Model C Standard XL | specs | 1.00 | 0.35 | 0.20 | 0.85 |
| 29 | Document revision date | specs | 1.00 | 0.48 | 0.30 | 0.85 |
| 30 | Encoder pulses per revolution | components | 1.00 | 0.52 | 0.38 | 0.85 |

### Easy Aggregate Metrics

| Metric | Value |
|--------|-------|
| Accuracy | 1.00 |
| Faithfulness | 1.00 |
| Claim Grounding | 0.33 |
| Hallucination Score | 0.45 |
| Confidence | 0.87 |
| Tokens | 118,827 |

## Medium Results (30/30 = 100%)

All 30 tests pass this run (v4: 29/30 with 1 flaky).

| # | Question | Acc | Status |
|---|----------|-----|--------|
| 1 | Inspection types supported by AV-FM/AV-FF | 1.00 | PASS |
| 2 | Components tracked by Tracker board | 1.00 | PASS |
| 3 | Differences between AV-FM and AV-FF | 1.00 | PASS |
| 4 | Sequence of steps in inspection process | 0.50 | PASS |
| 5 | User roles in the system | 1.00 | PASS |
| 6 | Three SKU states | 1.00 | PASS |
| 7 | Screens in main menu | 0.67 | PASS |
| 8 | Signal beacon light colors | 0.67 | PASS |
| 9 | Safety standards compliance | 1.00 | PASS |
| 10 | Types of cooling systems | 1.00 | PASS |
| 11 | Electrical current at 120V | 1.00 | PASS |
| 12 | GUI header information | 1.00 | PASS |
| 13 | Cap tracking tool parameters | 1.00 | PASS |
| 14 | Data recorded by inspection system | 1.00 | PASS |
| 15 | Equipment models in manual | 1.00 | PASS |
| 16 | Power failure handling | 1.00 | PASS |
| 17 | Communication protocols | 1.00 | PASS |
| 18 | Environmental conditions | 1.00 | PASS |
| 19 | Personal protective equipment | 1.00 | PASS |
| 20 | Global Learning function | 1.00 | PASS |
| 21 | Container parameters | 1.00 | PASS |
| 22 | Inactivity timeout | 1.00 | PASS |
| 23 | Grounding specification | 0.67 | PASS |
| 24 | IMAGO outputs | 1.00 | PASS |
| 25 | Encoder function | 1.00 | PASS |
| 26 | Simultaneous inspections | 1.00 | PASS |
| 27 | Multicam cap opacity options | 1.00 | PASS |
| 28 | Laser sensor in Profiler | 0.50 | PASS |
| 29 | Bottle rejection in fill level | 1.00 | PASS |
| 30 | Steps to copy a SKU | 1.00 | PASS |

Note: Medium still has flaky tests due to model non-determinism (gpt-oss-120b at temp=0 on Groq). All 30 pass collectively across runs.

## Hard Results (30/30 = 100%)

All 30 hard tests pass. No regression from v4.

## Super-Hard Results (49/50 = 98.0%)

### Category Breakdown

| Category | Tests | Passed | Rate | v4 |
|----------|-------|--------|------|----|
| synthesis (original 30) | 30 | 29 | 96.7% | 93.3% (28/30) |
| graph-multi-hop | 5 | 5 | **100%** | 100% |
| anti-hallucination | 5 | 5 | **100%** | 100% |
| numerical | 5 | 5 | **100%** | 100% |
| reasoning | 5 | 5 | **100%** | 100% |

Test 30 (normative standards) flipped FAIL→PASS thanks to synthesis mode + 1-hop graph expansion. Test 25 (bottles without caps) remains the single failure.

### Per-Test Results

| # | Question | Category | Acc | Status | v4 |
|---|----------|----------|-----|--------|-----|
| 1 | Troubleshooting incorrect rejections | synthesis | 1.00 | PASS | PASS |
| 2 | SKU container type switching | synthesis | 1.00 | PASS | PASS |
| 3 | Five inspection tools quality control | synthesis | 1.00 | PASS | PASS |
| 4 | Infrastructure requirements | synthesis | 0.67 | PASS | PASS |
| 5 | Partially filled beer bottle with foam | synthesis | 1.00 | PASS | PASS |
| 6 | Safety architecture analysis | synthesis | 1.00 | PASS | PASS |
| 7 | Failure modes and alarm responses | synthesis | 1.00 | PASS | PASS |
| 8 | 12-hour production shift accuracy | synthesis | 0.50 | PASS | PASS |
| 9 | Vortex vs Rittal AC comparison | synthesis | 1.00 | PASS | PASS |
| 10 | Small medicine bottle optimization | synthesis | 0.67 | PASS | PASS |
| 11 | MDIR 2006/42/EC influence | synthesis | 1.00 | PASS | PASS |
| 12 | Data architecture | synthesis | 1.00 | PASS | PASS |
| 13 | Maintenance risks and mitigations | synthesis | 1.00 | PASS | PASS |
| 14 | Post-installation calibration validation | synthesis | 0.67 | PASS | PASS |
| 15 | Normative standards synthesis | synthesis | 0.67 | PASS | PASS |
| 16 | Image resolution, lens, accuracy | synthesis | 1.00 | PASS | PASS |
| 17 | Concurrent multi-camera inspections | synthesis | 0.67 | PASS | PASS |
| 18 | User management lifecycle | synthesis | 1.00 | PASS | PASS |
| 19 | Container params during changeover | synthesis | 1.00 | PASS | PASS |
| 20 | Rejection timing at different speeds | synthesis | 1.00 | PASS | PASS |
| 21 | 10% humidity increase impact | synthesis | 1.00 | PASS | PASS |
| 22 | SKU strategy for 50 bottle sizes | synthesis | 1.00 | PASS | PASS |
| 23 | Electrical defense-in-depth | synthesis | 1.00 | PASS | PASS |
| 24 | Glossary inspection parameters | synthesis | 0.50 | PASS | PASS |
| **25** | **Bottles without caps** | **synthesis** | **0.33** | **FAIL** | **FAIL** |
| 26 | Operator training requirements | synthesis | 1.00 | PASS | PASS |
| 27 | Image acquisition pipeline | synthesis | 1.00 | PASS | PASS |
| 28 | Future upgrades and expansions | synthesis | 1.00 | PASS | PASS |
| 29 | Fill level measurement parameters | synthesis | 1.00 | PASS | PASS |
| **30** | **Normative standards and safety** | **synthesis** | **0.67** | **PASS** | **FAIL → PASS** |
| 31 | Foam compensation + window params | graph-multi-hop | 1.00 | PASS | PASS |
| 32 | Signal path trigger → rejection | graph-multi-hop | 1.00 | PASS | PASS |
| 33 | Alarm severity levels vs components | graph-multi-hop | 1.00 | PASS | PASS |
| 34 | Global Learning + pixel/mm + diameter | graph-multi-hop | 1.00 | PASS | PASS |
| 35 | Compensador 1 & 2 + encoder + low speed | graph-multi-hop | 1.00 | PASS | PASS |
| 36 | Max production speed (anti-halluc.) | anti-hallucination | 1.00 | PASS | PASS |
| 37 | Camera megapixels (anti-halluc.) | anti-hallucination | 1.00 | PASS | PASS |
| 38 | WiFi support (anti-halluc.) | anti-hallucination | 1.00 | PASS | PASS |
| 39 | ML/AI algorithms (anti-halluc.) | anti-hallucination | 1.00 | PASS | PASS |
| 40 | Cloud connectivity (anti-halluc.) | anti-hallucination | 1.00 | PASS | PASS |
| 41 | Current ratings 120V/240V | numerical | 1.00 | PASS | PASS |
| 42 | Weights Model A/B/C | numerical | 1.00 | PASS | PASS |
| 43 | Air pressure + edge size values | numerical | 1.00 | PASS | PASS |
| 44 | Ground voltage + wire gauge + cap | numerical | 1.00 | PASS | PASS |
| 45 | Timeout + pulse width + debounce | numerical | 0.67 | PASS | PASS |
| 46 | Encoder pulse divider calculation | reasoning | 1.00 | PASS | PASS |
| 47 | Foam compensation calculation | reasoning | 1.00 | PASS | PASS |
| 48 | SKU copy restriction | reasoning | 1.00 | PASS | PASS |
| 49 | Noise range 70-80 dB(A) | reasoning | 1.00 | PASS | PASS |
| 50 | Foam + Borde Inferior for beer | reasoning | 1.00 | PASS | PASS |

### Failure Analysis

**Test 25: "How does the system handle edge cases like bottles without caps?"** (CONSISTENT FAIL)

Root cause: **RETRIEVAL_MISS caused by cross-language translation failure.**

Investigation findings:
- Expected facts: `tapa|cap`, `defecto|defect|non-conform`, `presencia|presence`
- Found: Only "cap" (1/3). Model discusses cap-height tracking but never mentions presence/defect detection.
- Ground-truth content lives in section 7.3.2 "Presencia/Defecto de Tapa" (pp 131-135, chunks 25 and 29)
- **Neither ground-truth chunk appeared in the top 25 results**
- Cross-language translator mistranslated "caps" → "mayúscula" (uppercase letter) instead of "tapa" (bottle cap)
- "Edge cases" → "borde/arista" (physical edge) instead of the abstract concept
- Vector search gravitated to "Altura de Tapa" (cap height measurement) chunks instead of "Presencia/Defecto de Tapa" (cap presence/defect detection)
- All 3 expected facts exist in the DB and are embedded, but are semantically distant from the query phrasing

Fix options:
1. Improve cross-language translator with domain-specific disambiguation (risk: complexity, overfitting)
2. Query rewriting to expand "caps" → "tapa, presencia, defecto" in this domain context
3. Better chunking to keep section 7.3.2 content together

Status: Deferred — requires targeted improvement to cross-language translation for polysemous terms.

## Performance Impact

| Query Type | v4 | v5 |
|---|---|---|
| Normal query | 1 retrieval (25 results), 1-3 rounds | **Same** (synthesis detection is false) |
| Synthesis query | Same as normal | 1 retrieval (40 results + graph expansion), 1-3 rounds, + conditional follow-up |

No additional LLM calls for non-synthesis queries. Synthesis queries may add 1 embedding + 1 reasoning call when follow-up triggers.

## Files Modified in v5

| File | Changes |
|------|---------|
| `retrieval/helpers.go` | Added `isSynthesisQuery()` for synthesis query detection |
| `retrieval/retrieval.go` | Synthesis detection, adaptive max_results, 1-hop graph expansion, `SynthesisMode`/`MaxRequested`/`FollowUpTerms`/`FollowUpResults` in SearchTrace |
| `store/store.go` | Added `GetRelatedEntities()` for 1-hop relationship traversal |
| `goreason.go` | Follow-up retrieval in `Query()`, `extractMissingTerms()`, `mergeResults()`, `isFalsePositiveIdentifier()` |
| `cmd/eval/main.go` | Updated default models to groq/openai |

## Run Artifacts

| Difficulty | Run Dir | Report |
|-----------|---------|--------|
| All | `evals/runs/2026-02-04_11-14-40/` | 139/140 |
| Eval time | 11m 14s | skip-ingest mode |
| Tokens | 716,036 total | |
